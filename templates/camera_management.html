<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Management - Groundtruth Studio</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .topology-container {
            max-width: 1600px;
            margin: 8px auto;
            padding: 8px;
        }
        .topology-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 30px;
        }
        .topology-header h1 { font-size: 20px; }
        .topology-header a { padding: 8px 16px; font-size: 14px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 30px;
        }
        .stat-card { background: #2a2a2a; padding: 12px; border-radius: 8px; text-align: center; }
        .stat-card .number { font-size: 22px; font-weight: bold; color: #4CAF50; }
        .stat-card .label { font-size: 12px; color: #aaa; margin-top: 5px; }
        .content-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        .graph-panel {
            background: #2a2a2a; border-radius: 8px; padding: 10px;
            min-height: 300px; display: none;
        }
        .sidebar-panel { background: #2a2a2a; border-radius: 8px; padding: 10px; }
        .sidebar-panel h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .person-list { max-height: 250px; overflow-y: auto; }
        .person-item {
            padding: 12px; margin: 5px 0; background: #1a1a1a;
            border-radius: 4px; cursor: pointer; transition: background 0.2s; font-size: 14px;
        }
        .person-item:hover { background: #333; }
        .person-item.active { background: #3a4a3a; border-left: 3px solid #4CAF50; }
        .transition-list { max-height: 250px; overflow-y: auto; }
        .transition-item { padding: 8px; margin: 5px 0; background: #1a1a1a; border-radius: 4px; font-size: 12px; }
        .transition-item .camera-path { color: #4CAF50; font-weight: 500; }
        .transition-item .time { color: #666; font-size: 11px; }
        .suggestions-panel { margin-top: 20px; padding-top: 20px; border-top: 1px solid #444; padding: 15px; }
        .suggestion-item {
            padding: 10px; margin: 5px 0; background: #1a1a1a;
            border-radius: 4px; border-left: 3px solid #FFA500; font-size: 13px;
        }
        .suggestion-item .confidence {
            display: inline-block; padding: 2px 6px; border-radius: 3px;
            font-size: 11px; background: #FFA500; color: #000; font-weight: bold;
        }
        .suggestion-item .reasoning { font-size: 11px; color: #888; margin-top: 5px; }
        .suggestion-item button { margin-top: 8px; padding: 8px 12px; font-size: 13px; }
        #topology-graph { width: 100%; height: 600px; }
        .node circle { stroke: #4CAF50; stroke-width: 2px; }
        .node text { fill: #fff; font-size: 10px; pointer-events: none; }
        .link { stroke: #666; stroke-width: 2px; marker-end: url(#arrowhead); }
        .link.highlighted { stroke: #4CAF50; stroke-width: 3px; }
        .link-label { fill: #aaa; font-size: 8px; text-anchor: middle; }
        .empty-state { text-align: center; padding: 20px; color: #666; font-size: 14px; }
        .view-toggle {
            display: flex; gap: 0; margin-bottom: 15px;
            background: #ecf0f1; border-radius: 8px; padding: 4px;
        }
        .view-toggle-btn {
            flex: 1; padding: 10px 16px; border: none; background: transparent;
            font-size: 14px; font-weight: 500; color: #7f8c8d;
            cursor: pointer; border-radius: 6px; transition: all 0.2s; min-height: 44px;
        }
        .view-toggle-btn.active { background: white; color: #2c3e50; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .topology-list-view {
            background: white; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: block;
        }
        .topology-list-item {
            display: flex; align-items: center; padding: 12px;
            border-bottom: 1px solid #eee; gap: 12px;
        }
        .topology-list-item:last-child { border-bottom: none; }
        .list-camera-name { font-weight: 600; color: #2c3e50; font-size: 15px; }
        .list-camera-meta { font-size: 13px; color: #7f8c8d; }
        .list-camera-connections { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .list-connection-badge {
            background: #ebf5fb; color: #2980b9;
            padding: 3px 10px; border-radius: 12px; font-size: 12px;
        }
        .list-view-loading { text-align: center; padding: 40px; color: #7f8c8d; }
        svg { max-width: 100%; height: auto; }

        @media (min-width: 768px) {
            .topology-container { padding: 15px; }
            .topology-header { flex-direction: row; justify-content: space-between; align-items: center; }
            .topology-header h1 { font-size: 22px; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .stat-card { padding: 15px; }
            .stat-card .number { font-size: 26px; }
            .graph-panel { display: block; min-height: 400px; padding: 15px; }
            .topology-list-view { display: none; }
            .topology-list-view.view-visible { display: block; }
            .graph-panel.view-hidden { display: none; }
            .sidebar-panel { padding: 15px; }
            .person-list { max-height: 300px; }
            .person-item { font-size: 15px; }
            .transition-item { padding: 10px; font-size: 13px; }
            .node text { font-size: 12px; }
            .link-label { font-size: 9px; }
        }
        @media (min-width: 1024px) {
            .topology-container { padding: 20px; }
            .content-grid { grid-template-columns: 2fr 1fr; gap: 20px; }
            .graph-panel { min-height: 600px; padding: 20px; }
            .sidebar-panel { padding: 20px; max-height: none; }
            .person-list { max-height: 400px; }
            .stat-card { padding: 20px; }
            .stat-card .number { font-size: 32px; }
            .stat-card .label { font-size: 14px; }
            .transition-list { max-height: 300px; }
            .transition-item { font-size: 13px; }
            .stats-grid { grid-template-columns: repeat(6, 1fr); }
        }
        @media (max-width: 767px) and (orientation: landscape) {
            .graph-panel { min-height: 350px; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (hover: none) and (pointer: coarse) {
            .person-item, .suggestion-item button, button, .view-toggle-btn { min-height: 44px; }
            .person-item { padding: 14px; border: 1px solid rgba(255,255,255,0.1); }
            .person-item:hover { background: #1a1a1a; }
            .node circle { r: 12; }
            .node:hover circle { fill: #4CAF50; }
        }

        /* Tabs */
        .topology-tabs {
            display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #444;
        }
        .tab-btn {
            padding: 12px 24px; background: transparent; border: none;
            color: #888; font-size: 15px; font-weight: 500; cursor: pointer;
            border-bottom: 2px solid transparent; margin-bottom: -2px;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-btn:hover { color: #ccc; }
        .tab-btn.active { color: #4CAF50; border-bottom-color: #4CAF50; }
        .tab-content { display: block; }
        .tab-content:not(.active) { display: none !important; }

        /* Camera List */
        .camera-filter-bar { margin: 10px 0; }
        .camera-list { max-height: 550px; overflow-y: auto; }
        .camera-list-item {
            padding: 12px; margin: 5px 0; background: #1a1a1a; border-radius: 4px;
            cursor: pointer; transition: background 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .camera-list-item:hover { background: #333; }
        .camera-list-item.active { background: #3a4a3a; border-left: 3px solid #4CAF50; }
        .camera-list-item .camera-mac { font-family: monospace; font-size: 13px; color: #4CAF50; }
        .camera-list-item .camera-info { font-size: 12px; color: #888; margin-top: 2px; }
        .camera-list-item .camera-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 11px; font-weight: 500;
        }
        .camera-badge.has-location { background: rgba(76,175,80,0.2); color: #4CAF50; }
        .camera-badge.no-location { background: rgba(255,165,0,0.2); color: #FFA500; }

        /* Location Form */
        .location-form { margin-top: 15px; }
        .location-form .form-group { margin-bottom: 12px; }
        .location-form label { display: block; font-size: 13px; color: #aaa; margin-bottom: 4px; }
        .location-form input,
        .location-form textarea,
        .location-form select {
            width: 100%; padding: 8px; background: #1a1a1a;
            border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 14px;
        }
        .location-form .form-actions { display: flex; gap: 10px; margin-top: 15px; }

        /* Reference images */
        .reference-image-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px; max-height: 250px; overflow-y: auto;
        }
        .reference-image-grid .ref-thumb {
            width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 4px;
            cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s;
        }
        .reference-image-grid .ref-thumb:hover { border-color: #4CAF50; }
        .reference-image-grid .ref-thumb.selected {
            border-color: #4CAF50; box-shadow: 0 0 8px rgba(76,175,80,0.4);
        }

        /* Export */
        .export-stats-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;
        }
        .export-stat-card { background: #1a1a1a; padding: 12px; border-radius: 4px; text-align: center; }
        .export-stat-card .location-label { color: #4CAF50; font-weight: 500; font-size: 14px; }
        .export-stat-card .frame-count { color: #fff; font-size: 20px; font-weight: bold; }
        .export-stat-card .source-info { color: #888; font-size: 11px; margin-top: 4px; }

        /* ===== Aliases Tab ===== */
        .aliases-layout { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 1024px) { .aliases-layout { grid-template-columns: 2fr 1fr; gap: 20px; } }

        .aliases-panel { background: #2a2a2a; border-radius: 8px; padding: 15px; }
        .aliases-panel h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 12px; }

        .alias-filter-bar { margin-bottom: 12px; }
        .alias-filter-bar input {
            width: 100%; padding: 8px 10px; background: #1a1a1a; border: 1px solid #444;
            color: #fff; border-radius: 4px; font-size: 14px; box-sizing: border-box;
        }
        .alias-filter-bar input::placeholder { color: #555; }

        .alias-table-wrap { overflow-x: auto; }
        .alias-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .alias-table th {
            text-align: left; padding: 8px 10px; color: #888; font-weight: 500;
            border-bottom: 1px solid #444; white-space: nowrap;
        }
        .alias-table td { padding: 9px 10px; border-bottom: 1px solid #333; vertical-align: middle; }
        .alias-table tr:last-child td { border-bottom: none; }
        .alias-table tr:hover td { background: #333; }
        .alias-id-cell { font-family: monospace; color: #4CAF50; font-size: 12px; }
        .alias-primary-cell { font-family: monospace; color: #aaa; font-size: 12px; }
        .alias-type-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px;
            font-weight: 500; background: rgba(76,175,80,0.15); color: #4CAF50; text-transform: lowercase;
        }
        .alias-date-cell { color: #666; font-size: 12px; white-space: nowrap; }
        .alias-delete-btn {
            padding: 4px 10px; background: transparent; border: 1px solid #c0392b;
            color: #e74c3c; border-radius: 4px; font-size: 12px; cursor: pointer;
            transition: background 0.15s, color 0.15s; white-space: nowrap;
        }
        .alias-delete-btn:hover { background: rgba(231,76,60,0.15); }
        .alias-count-label { font-size: 12px; color: #666; margin-bottom: 8px; }

        /* Add Alias Form */
        .alias-form { background: #2a2a2a; border-radius: 8px; padding: 15px; }
        .alias-form h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
        .alias-form .form-group { margin-bottom: 12px; }
        .alias-form label { display: block; font-size: 13px; color: #aaa; margin-bottom: 4px; }
        .alias-form input,
        .alias-form select {
            width: 100%; padding: 8px 10px; background: #1a1a1a; border: 1px solid #444;
            color: #fff; border-radius: 4px; font-size: 14px; box-sizing: border-box;
        }
        .alias-form input::placeholder { color: #555; }
        .alias-form select option { background: #1a1a1a; }
        .alias-form .form-actions { margin-top: 15px; }
        .alias-status-msg {
            margin-top: 10px; padding: 8px 12px; border-radius: 4px;
            font-size: 13px; display: none;
        }
        .alias-status-msg.success {
            background: rgba(76,175,80,0.15); border: 1px solid #4CAF50; color: #4CAF50;
        }
        .alias-status-msg.error {
            background: rgba(231,76,60,0.12); border: 1px solid #e74c3c; color: #e74c3c;
        }
        .rbac-readonly-notice {
            padding: 10px 14px; background: rgba(255,165,0,0.08);
            border: 1px solid rgba(255,165,0,0.3); border-radius: 4px;
            color: #FFA500; font-size: 13px; margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <script>var CAN_WRITE = {{ 'true' if can_write else 'false' }};</script>
    <script src="/static/js/gt-utils.js"></script>
    <script src="/static/js/responsive-utils.js"></script>
    {% include 'partials/nav.html' %}
    <div class="topology-container">
        <div class="topology-header">
            <div>
                <h1>Camera Management</h1>
                <p style="color:#666; margin-top:5px;">Network topology, location assignment, and ID aliases</p>
            </div>
            <a href="/camera-map" class="btn" style="border:1px solid #4CAF50; color:#4CAF50; background:transparent; text-decoration:none; display:inline-block;">Open Camera Map</a>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="stat-cameras">0</div>
                <div class="label">Cameras</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-transitions">0</div>
                <div class="label">Transitions</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-people">0</div>
                <div class="label">Tracked People</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-paths">0</div>
                <div class="label">Known Paths</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-locations">0</div>
                <div class="label">Locations</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-aliases">0</div>
                <div class="label">Aliases</div>
            </div>
        </div>

        <div class="topology-tabs">
            <button class="tab-btn active" onclick="switchTab('network')">Camera Network</button>
            <button class="tab-btn" onclick="switchTab('locations')">Locations</button>
            <button class="tab-btn" onclick="switchTab('aliases')">Aliases</button>
        </div>

        <!-- TAB: Camera Network -->
        <div id="tab-network" class="tab-content active">
            <div class="view-toggle" id="view-toggle">
                <button class="view-toggle-btn active" data-view="list" onclick="toggleTopologyView('list')">List View</button>
                <button class="view-toggle-btn" data-view="graph" onclick="toggleTopologyView('graph')">Graph View</button>
            </div>
            <div class="topology-list-view" id="topology-list-view">
                <div class="list-view-loading">Loading camera connections...</div>
            </div>
            <div class="content-grid">
                <div class="graph-panel">
                    <h3>Camera Network Graph</h3>
                    <div id="topology-graph"></div>
                </div>
                <div class="sidebar-panel">
                    <h3>People</h3>
                    <div class="person-list" id="person-list">
                        <div class="empty-state">Loading...</div>
                    </div>
                    <div id="person-details" style="display:none;">
                        <h3 style="margin-top:20px;">Movement Path</h3>
                        <div class="transition-list" id="transition-list"></div>
                        <div class="suggestions-panel" id="suggestions-panel">
                            <h3>Suggested Matches</h3>
                            <p style="font-size:12px; color:#666;">Unassigned detections that might be this person</p>
                            <div id="suggestions-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Locations -->
        <div id="tab-locations" class="tab-content">
            <div class="content-grid">
                <div class="graph-panel">
                    <h3>Discovered Cameras</h3>
                    <div class="camera-filter-bar">
                        <input type="text" id="camera-search" placeholder="Filter cameras by MAC or name..." style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:#fff; border-radius:4px;">
                    </div>
                    <div class="camera-list" id="camera-list">
                        <div class="empty-state">Loading cameras...</div>
                    </div>
                </div>
                <div class="sidebar-panel">
                    <div id="location-no-selection" class="empty-state">
                        <p>Select a camera from the list to assign a location</p>
                    </div>
                    <div id="location-form-container" style="display:none;">
                        <h3 id="selected-camera-title">Camera Details</h3>
                        <div class="location-form">
                            <div class="form-group">
                                <label>Camera MAC</label>
                                <input type="text" id="loc-camera-id" readonly style="background:#333; color:#888;">
                            </div>
                            <div class="form-group">
                                <label>Camera Name</label>
                                <input type="text" id="loc-camera-name" placeholder="Display name...">
                            </div>
                            <div class="form-group">
                                <label>Location Name <span style="color:#e74c3c;">*</span></label>
                                <input type="text" id="loc-location-name" placeholder="e.g., Cedar Key Boat Ramp" list="location-suggestions">
                                <datalist id="location-suggestions"></datalist>
                            </div>
                            <div class="form-group">
                                <label>Site Name</label>
                                <input type="text" id="loc-site-name" placeholder="Site name from EcoEye...">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="loc-description" placeholder="Optional details about this location..." rows="2"></textarea>
                            </div>
                            <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <div>
                                    <label>Latitude</label>
                                    <input type="number" id="loc-latitude" step="any" placeholder="Optional">
                                </div>
                                <div>
                                    <label>Longitude</label>
                                    <input type="number" id="loc-longitude" step="any" placeholder="Optional">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-primary" onclick="saveLocation()">Save Location</button>
                                <button class="btn btn-danger" id="btn-remove-location" onclick="removeLocation()" style="display:none;">Remove</button>
                            </div>
                        </div>
                        <h3 style="margin-top:20px;">Reference Images</h3>
                        <p style="font-size:12px; color:#666; margin-bottom:10px;">Click a thumbnail to set as reference image</p>
                        <div class="reference-image-grid" id="reference-images">
                            <div class="empty-state">No frames available</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="export-section" style="margin-top:20px;">
                <div class="graph-panel">
                    <h3>Export Training Data</h3>
                    <div id="export-stats" class="export-stats-grid">
                        <div class="empty-state">Loading export statistics...</div>
                    </div>
                    <div class="export-controls" style="margin-top:15px; display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                        <div>
                            <label style="color:#aaa; font-size:13px;">Format</label>
                            <select id="export-format" style="padding:8px; background:#1a1a1a; border:1px solid #444; color:#fff; border-radius:4px;">
                                <option value="imagefolder">ImageFolder (PyTorch)</option>
                                <option value="csv">CSV + Frames</option>
                            </select>
                        </div>
                        <div>
                            <label style="color:#aaa; font-size:13px;">Val Split</label>
                            <input type="range" id="export-val-split" min="0.05" max="0.5" step="0.05" value="0.2" oninput="document.getElementById('val-split-label').textContent = Math.round(this.value*100) + '%'">
                            <span id="val-split-label" style="color:#fff; font-size:13px;">20%</span>
                        </div>
                        <button class="btn btn-primary" onclick="exportDataset()" id="btn-export">Export Dataset</button>
                    </div>
                    <div id="export-result" style="margin-top:15px; display:none;"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Aliases -->
        <div id="tab-aliases" class="tab-content">
            <div class="aliases-layout">
                <div class="aliases-panel">
                    <h3>Camera Aliases</h3>
                    <div class="alias-filter-bar">
                        <input type="text" id="alias-search" placeholder="Filter by camera ID or alias..." oninput="renderAliasTable()">
                    </div>
                    <div class="alias-count-label" id="alias-count-label">Loading...</div>
                    <div class="alias-table-wrap">
                        <table class="alias-table">
                            <thead>
                                <tr>
                                    <th>Primary Camera ID</th>
                                    <th>Alias ID</th>
                                    <th>Type</th>
                                    <th>Created</th>
                                    <th id="alias-actions-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alias-table-body">
                                <tr><td colspan="5" class="empty-state">Loading aliases...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="alias-form">
                    <h3>Add Alias</h3>
                    <div id="alias-rbac-notice" class="rbac-readonly-notice" style="display:none;">
                        You have read-only access. Contact an admin to add or remove aliases.
                    </div>
                    <div id="alias-add-form-fields">
                        <div class="form-group">
                            <label>Primary Camera ID</label>
                            <input type="text" id="alias-primary-id" placeholder="e.g., aabbccddeeff" list="alias-primary-datalist" autocomplete="off">
                            <datalist id="alias-primary-datalist"></datalist>
                        </div>
                        <div class="form-group">
                            <label>Alias ID</label>
                            <input type="text" id="alias-alias-id" placeholder="e.g., Unifi camera ID or MAC" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="alias-type">
                                <option value="unifi">Unifi</option>
                                <option value="frigate">Frigate</option>
                                <option value="mac">MAC</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="addAlias()" id="btn-add-alias">Add Alias</button>
                        </div>
                        <div class="alias-status-msg" id="alias-status-msg"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        var graphData = null;
        var selectedPerson = null;
        var svg, simulation;

        async function loadTopology() {
            try {
                var response = await fetch('/api/camera-topology/graph');
                var data = await response.json();
                if (data.success) {
                    graphData = data.graph;
                    updateStats();
                    renderGraph();
                    await loadPeople();
                }
            } catch (error) {
                console.error('Error loading topology:', error);
            }
        }

        function updateStats() {
            document.getElementById('stat-cameras').textContent = graphData.nodes.length;
            document.getElementById('stat-transitions').textContent = graphData.total_transitions;
            document.getElementById('stat-people').textContent = graphData.unique_people;
            document.getElementById('stat-paths').textContent = graphData.edges.length;
        }

        async function loadPeople() {
            try {
                var response = await fetch('/api/person-names/recent?limit=100');
                var data = await response.json();
                if (data.success && data.names.length > 0) {
                    var container = document.getElementById('person-list');
                    container.innerHTML = data.names.map(function(name) {
                        return '<div class="person-item" onclick="selectPerson(\'' + name + '\')">' + name + '</div>';
                    }).join('');
                } else {
                    document.getElementById('person-list').innerHTML = '<div class="empty-state">No tracked people yet</div>';
                }
            } catch (error) {
                console.error('Error loading people:', error);
            }
        }

        async function selectPerson(name) {
            selectedPerson = name;
            document.querySelectorAll('.person-item').forEach(function(item) {
                item.classList.remove('active');
                if (item.textContent.trim() === name) item.classList.add('active');
            });
            try {
                var response = await fetch('/api/camera-topology/person/' + encodeURIComponent(name) + '/path');
                var data = await response.json();
                if (data.success) {
                    displayPersonPath(data.path);
                    highlightPersonPath(data.path);
                }
            } catch (error) {
                console.error('Error loading person path:', error);
            }
            loadSuggestions(name);
            document.getElementById('person-details').style.display = 'block';
        }

        function displayPersonPath(path) {
            var container = document.getElementById('transition-list');
            if (path.length === 0) {
                container.innerHTML = '<div class="empty-state">No transitions recorded</div>';
                return;
            }
            container.innerHTML = path.map(function(step) {
                return '<div class="transition-item"><div class="camera-path">' +
                    (step.from_camera ? step.from_camera + ' &rarr; ' : '') + step.camera +
                    '</div>' +
                    (step.transition_time_seconds ? '<div class="time">Transit time: ' + step.transition_time_seconds.toFixed(1) + 's</div>' : '') +
                    '</div>';
            }).join('');
        }

        async function loadSuggestions(name) {
            try {
                var response = await fetch('/api/camera-topology/suggest-links', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({person_name: name, time_window_seconds: 300})
                });
                var data = await response.json();
                if (data.success && data.suggestions.length > 0) {
                    var container = document.getElementById('suggestions-list');
                    container.innerHTML = data.suggestions.slice(0, 5).map(function(sug) {
                        return '<div class="suggestion-item"><div><span class="confidence">' +
                            (sug.confidence * 100).toFixed(0) + '%</span> ' +
                            sug.unknown_camera + ' @ ' + sug.unknown_timestamp.toFixed(1) + 's</div>' +
                            '<div class="reasoning">' + sug.reasoning.join(', ') + '</div>' +
                            '<button class="btn btn-primary btn-small" onclick="assignSuggestion(' +
                            sug.unknown_detection_id + ', \'' + name + '\')">Assign to ' + name + '</button></div>';
                    }).join('');
                } else {
                    document.getElementById('suggestions-list').innerHTML = '<div class="empty-state">No suggestions</div>';
                }
            } catch (error) {
                console.error('Error loading suggestions:', error);
            }
        }

        async function assignSuggestion(detectionId, name) {
            try {
                var response = await fetch('/api/person-detections/assign-name', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({detection_ids: [detectionId], person_name: name})
                });
                var data = await response.json();
                if (data.success) {
                    alert('Assigned successfully!');
                    await loadTopology();
                    selectPerson(name);
                }
            } catch (error) {
                console.error('Error assigning:', error);
                alert('Error assigning detection');
            }
        }

        function highlightPersonPath(path) {
            if (!svg) return;
            svg.selectAll('.link').classed('highlighted', false);
            for (var i = 0; i < path.length - 1; i++) {
                var from = path[i].camera;
                var to = path[i + 1].camera;
                svg.selectAll('.link').filter(function(d) {
                    return d.source.id === from && d.target.id === to;
                }).classed('highlighted', true);
            }
        }

        function renderGraph() {
            var container = document.getElementById('topology-graph');
            var width = container.offsetWidth;
            var height = 600;
            container.innerHTML = '';
            if (graphData.nodes.length === 0) {
                container.innerHTML = '<div class="empty-state">No camera connections yet.<br>Start tagging the same person across multiple videos!</div>';
                return;
            }
            svg = d3.select('#topology-graph').append('svg').attr('width', width).attr('height', height);
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead').attr('markerWidth', 10).attr('markerHeight', 10)
                .attr('refX', 20).attr('refY', 3).attr('orient', 'auto')
                .append('polygon').attr('points', '0 0, 10 3, 0 6').style('fill', '#666');
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.edges).id(function(d) { return d.id; }).distance(150))
                .force('charge', d3.forceManyBody().strength(-500))
                .force('center', d3.forceCenter(width / 2, height / 2));
            var link = svg.append('g').selectAll('line').data(graphData.edges).join('line').attr('class', 'link');
            var linkLabel = svg.append('g').selectAll('text').data(graphData.edges).join('text')
                .attr('class', 'link-label')
                .text(function(d) { return d.transition_count + ' (' + d.avg_time_seconds.toFixed(0) + 's)'; });
            var node = svg.append('g').selectAll('g').data(graphData.nodes).join('g').attr('class', 'node')
                .call(d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended));
            node.append('circle').attr('r', function(d) { return 10 + (d.detection_count / 2); }).attr('fill', '#1a1a1a');
            node.append('text').attr('dx', 15).attr('dy', 4)
                .text(function(d) { return d.label + ' (' + d.detection_count + ')'; });
            simulation.on('tick', function() {
                link.attr('x1', function(d) { return d.source.x; }).attr('y1', function(d) { return d.source.y; })
                    .attr('x2', function(d) { return d.target.x; }).attr('y2', function(d) { return d.target.y; });
                linkLabel
                    .attr('x', function(d) { return (d.source.x + d.target.x) / 2; })
                    .attr('y', function(d) { return (d.source.y + d.target.y) / 2; });
                node.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
            });
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x; d.fy = d.y;
            }
            function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null; d.fy = null;
            }
        }

        // ===== Locations Tab =====
        var discoveredCameras = [];
        var selectedCamera = null;
        var locationMappings = [];
        var selectedLocationId = null;

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            if (tab === 'network') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('tab-network').classList.add('active');
            } else if (tab === 'locations') {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('tab-locations').classList.add('active');
                loadDiscoveredCameras();
                loadExportStats();
            } else if (tab === 'aliases') {
                document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
                document.getElementById('tab-aliases').classList.add('active');
                loadAliases();
            }
        }

        async function loadDiscoveredCameras() {
            try {
                var response = await fetch('/api/camera-locations/cameras');
                var data = await response.json();
                if (data.success) {
                    discoveredCameras = data.cameras;
                    renderCameraList();
                    updateLocationCount();
                    loadLocationSuggestions();
                }
            } catch (error) {
                console.error('Error loading cameras:', error);
            }
        }

        function updateLocationCount() {
            var count = discoveredCameras.filter(function(c) { return c.location_name; }).length;
            document.getElementById('stat-locations').textContent = count;
        }

        function renderCameraList(filter) {
            filter = filter || '';
            var container = document.getElementById('camera-list');
            var filtered = discoveredCameras.filter(function(c) {
                if (!filter) return true;
                var f = filter.toLowerCase();
                return (c.camera_id && c.camera_id.toLowerCase().includes(f)) ||
                       (c.camera_name && c.camera_name.toLowerCase().includes(f)) ||
                       (c.location_name && c.location_name.toLowerCase().includes(f));
            });
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">No cameras found</div>';
                return;
            }
            container.innerHTML = filtered.map(function(cam) {
                var mac = cam.camera_id || 'Unknown';
                var displayMac = mac.length === 12 ? mac.match(/.{2}/g).join(':') : mac;
                var isActive = selectedCamera && selectedCamera.camera_id === cam.camera_id;
                return '<div class="camera-list-item ' + (isActive ? 'active' : '') +
                    '" onclick="selectCamera(\'' + cam.camera_id + '\')">' +
                    '<div><div class="camera-mac">' + displayMac + '</div>' +
                    '<div class="camera-info">' + (cam.camera_name || cam.site_name || 'Unnamed') +
                    ' &middot; ' + cam.total_events + ' events</div></div>' +
                    '<span class="camera-badge ' + (cam.location_name ? 'has-location' : 'no-location') + '">' +
                    (cam.location_name || 'Unassigned') + '</span></div>';
            }).join('');
        }

        function loadLocationSuggestions() {
            var datalist = document.getElementById('location-suggestions');
            var uniqueLocations = [];
            var seen = {};
            discoveredCameras.forEach(function(c) {
                if (c.location_name && !seen[c.location_name]) {
                    seen[c.location_name] = true;
                    uniqueLocations.push(c.location_name);
                }
            });
            datalist.innerHTML = uniqueLocations.map(function(loc) { return '<option value="' + loc + '">'; }).join('');
        }

        async function selectCamera(cameraId) {
            selectedCamera = discoveredCameras.find(function(c) { return c.camera_id === cameraId; });
            if (!selectedCamera) return;
            renderCameraList(document.getElementById('camera-search').value);
            document.getElementById('location-no-selection').style.display = 'none';
            document.getElementById('location-form-container').style.display = 'block';
            var mac = cameraId.length === 12 ? cameraId.match(/.{2}/g).join(':') : cameraId;
            document.getElementById('selected-camera-title').textContent = 'Camera ' + mac;
            document.getElementById('loc-camera-id').value = cameraId;
            document.getElementById('loc-camera-name').value = selectedCamera.camera_name || '';
            if (selectedCamera.location_id) {
                selectedLocationId = selectedCamera.location_id;
                try {
                    var resp = await fetch('/api/camera-locations/lookup/' + cameraId);
                    var data = await resp.json();
                    if (data.success && data.location) {
                        document.getElementById('loc-location-name').value = data.location.location_name || '';
                        document.getElementById('loc-site-name').value = data.location.site_name || '';
                        document.getElementById('loc-description').value = data.location.location_description || '';
                        document.getElementById('loc-latitude').value = data.location.latitude || '';
                        document.getElementById('loc-longitude').value = data.location.longitude || '';
                        document.getElementById('btn-remove-location').style.display = 'inline-block';
                    }
                } catch (e) {
                    console.error('Error fetching location:', e);
                }
            } else {
                selectedLocationId = null;
                document.getElementById('loc-location-name').value = '';
                document.getElementById('loc-site-name').value = selectedCamera.site_name || '';
                document.getElementById('loc-description').value = '';
                document.getElementById('loc-latitude').value = '';
                document.getElementById('loc-longitude').value = '';
                document.getElementById('btn-remove-location').style.display = 'none';
            }
            loadReferenceImages(cameraId);
        }

        async function loadReferenceImages(cameraId) {
            var container = document.getElementById('reference-images');
            try {
                var resp = await fetch('/api/videos?camera_id=' + encodeURIComponent(cameraId) + '&limit=20');
                var data = await resp.json();
                if (data.success && data.videos && data.videos.length > 0) {
                    container.innerHTML = data.videos.filter(function(v) { return v.thumbnail_path; })
                        .map(function(v) {
                            var thumbName = v.thumbnail_path.split('/').pop();
                            return '<img class="ref-thumb" src="/thumbnails/' + thumbName +
                                '" title="' + (v.title || v.filename) +
                                '" onclick="setReferenceImage(\'' + v.thumbnail_path + '\', this)">';
                        }).join('');
                    if (container.innerHTML === '') container.innerHTML = '<div class="empty-state">No thumbnails available</div>';
                } else {
                    container.innerHTML = '<div class="empty-state">No frames from this camera</div>';
                }
            } catch (e) {
                container.innerHTML = '<div class="empty-state">Error loading frames</div>';
            }
        }

        async function setReferenceImage(imagePath, imgEl) {
            if (!selectedLocationId) { alert('Save the location first, then set a reference image.'); return; }
            try {
                var resp = await fetch('/api/camera-locations/' + selectedLocationId + '/reference-image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({image_path: imagePath})
                });
                var data = await resp.json();
                if (data.success) {
                    document.querySelectorAll('.ref-thumb').forEach(function(t) { t.classList.remove('selected'); });
                    imgEl.classList.add('selected');
                }
            } catch (e) {
                console.error('Error setting reference image:', e);
            }
        }

        async function saveLocation() {
            var cameraId = document.getElementById('loc-camera-id').value;
            var locationName = document.getElementById('loc-location-name').value.trim();
            if (!locationName) { alert('Location name is required'); return; }
            try {
                var resp = await fetch('/api/camera-locations', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        camera_id: cameraId,
                        camera_name: document.getElementById('loc-camera-name').value.trim() || null,
                        location_name: locationName,
                        site_name: document.getElementById('loc-site-name').value.trim() || null,
                        location_description: document.getElementById('loc-description').value.trim() || null,
                        latitude: parseFloat(document.getElementById('loc-latitude').value) || null,
                        longitude: parseFloat(document.getElementById('loc-longitude').value) || null
                    })
                });
                var data = await resp.json();
                if (data.success) {
                    selectedLocationId = data.id;
                    document.getElementById('btn-remove-location').style.display = 'inline-block';
                    await loadDiscoveredCameras();
                    selectCamera(cameraId);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error saving location:', e);
                alert('Error saving location');
            }
        }

        async function removeLocation() {
            if (!selectedLocationId) return;
            if (!confirm('Remove this location assignment?')) return;
            try {
                var resp = await fetch('/api/camera-locations/' + selectedLocationId, {method: 'DELETE'});
                var data = await resp.json();
                if (data.success) {
                    selectedLocationId = null;
                    await loadDiscoveredCameras();
                    if (selectedCamera) selectCamera(selectedCamera.camera_id);
                }
            } catch (e) {
                console.error('Error removing location:', e);
            }
        }

        async function loadExportStats() {
            try {
                var resp = await fetch('/api/location-export/stats');
                var data = await resp.json();
                if (data.success && data.stats) {
                    var stats = data.stats;
                    var container = document.getElementById('export-stats');
                    if (stats.locations && stats.locations.length > 0) {
                        container.innerHTML = stats.locations.map(function(loc) {
                            return '<div class="export-stat-card">' +
                                '<div class="location-label">' + loc.location_name + '</div>' +
                                '<div class="frame-count">' + loc.total_frames + '</div>' +
                                '<div class="source-info">' + (loc.manual_frames || 0) + ' manual + ' + (loc.auto_frames || 0) + ' auto-labeled</div>' +
                                '</div>';
                        }).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state">No locations with training data yet. Assign camera locations above to auto-label frames.</div>';
                    }
                }
            } catch (e) {
                console.error('Error loading export stats:', e);
            }
        }

        async function exportDataset() {
            var btn = document.getElementById('btn-export');
            btn.disabled = true;
            btn.textContent = 'Exporting...';
            try {
                var resp = await fetch('/api/location-export/export', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        format: document.getElementById('export-format').value,
                        val_split: parseFloat(document.getElementById('export-val-split').value)
                    })
                });
                var data = await resp.json();
                var resultDiv = document.getElementById('export-result');
                resultDiv.style.display = 'block';
                if (data.success) {
                    resultDiv.innerHTML = '<div style="background:#1a3a1a; border:1px solid #4CAF50; border-radius:4px; padding:15px; color:#4CAF50;">' +
                        '<strong>Export complete!</strong><br>' +
                        '<span style="color:#aaa;">Path: ' + (data.output_dir || 'N/A') + '</span><br>' +
                        '<span style="color:#aaa;">Format: ' + (data.format || 'N/A') + '</span><br>' +
                        '<span style="color:#aaa;">Total frames: ' + (data.total_frames || 0) +
                        ' (Train: ' + (data.train_count || 0) + ', Val: ' + (data.val_count || 0) + ')</span><br>' +
                        '<span style="color:#aaa;">Locations: ' + (data.location_count || 0) + '</span></div>';
                } else {
                    resultDiv.innerHTML = '<div style="background:#3a1a1a; border:1px solid #e74c3c; border-radius:4px; padding:15px; color:#e74c3c;">' +
                        '<strong>Export failed:</strong> ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (e) {
                console.error('Error exporting:', e);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Export Dataset';
            }
        }

        function toggleTopologyView(view) {
            var listView = document.getElementById('topology-list-view');
            var graphPanel = document.querySelector('.graph-panel');
            document.querySelectorAll('.view-toggle-btn').forEach(function(b) { b.classList.remove('active'); });
            document.querySelector('[data-view="' + view + '"]').classList.add('active');
            if (view === 'list') {
                if (listView) { listView.style.display = 'block'; listView.classList.add('view-visible'); }
                if (graphPanel) { graphPanel.style.display = 'none'; graphPanel.classList.add('view-hidden'); }
                populateListView();
            } else {
                if (listView) { listView.style.display = 'none'; listView.classList.remove('view-visible'); }
                if (graphPanel) { graphPanel.style.display = 'block'; graphPanel.classList.remove('view-hidden'); }
            }
        }

        function populateListView() {
            var listView = document.getElementById('topology-list-view');
            if (!listView || listView.dataset.loaded === 'true') return;
            fetch('/api/camera-topology/graph').then(function(r) { return r.json(); }).then(function(data) {
                if (!data.graph || !data.graph.nodes || data.graph.nodes.length === 0) {
                    listView.innerHTML = '';
                    var loadingDiv = document.createElement('div');
                    loadingDiv.className = 'list-view-loading';
                    loadingDiv.textContent = 'No camera data available yet.';
                    listView.appendChild(loadingDiv);
                    return;
                }
                var graph = data.graph;
                listView.innerHTML = '';
                graph.nodes.forEach(function(node) {
                    var connections = (graph.edges || [])
                        .filter(function(l) {
                            return l.source === node.id || l.target === node.id ||
                                   (l.source && l.source.id === node.id) ||
                                   (l.target && l.target.id === node.id);
                        })
                        .map(function(l) {
                            var otherId = (l.source === node.id || (l.source && l.source.id === node.id))
                                ? (l.target.id || l.target) : (l.source.id || l.source);
                            var otherNode = graph.nodes.find(function(n) { return n.id === otherId; });
                            return otherNode ? otherNode.label || otherNode.id : otherId;
                        });
                    var itemDiv = document.createElement('div');
                    itemDiv.className = 'topology-list-item';
                    var contentDiv = document.createElement('div');
                    var nameDiv = document.createElement('div');
                    nameDiv.className = 'list-camera-name';
                    nameDiv.textContent = node.label || node.id;
                    var metaDiv = document.createElement('div');
                    metaDiv.className = 'list-camera-meta';
                    metaDiv.textContent = (node.location || 'No location') + ' \u00b7 ' + (node.detection_count || 0) + ' detections';
                    contentDiv.appendChild(nameDiv);
                    contentDiv.appendChild(metaDiv);
                    if (connections.length > 0) {
                        var connectionsDiv = document.createElement('div');
                        connectionsDiv.className = 'list-camera-connections';
                        connections.forEach(function(c) {
                            var badge = document.createElement('span');
                            badge.className = 'list-connection-badge';
                            badge.textContent = '\u2192 ' + c;
                            connectionsDiv.appendChild(badge);
                        });
                        contentDiv.appendChild(connectionsDiv);
                    }
                    itemDiv.appendChild(contentDiv);
                    listView.appendChild(itemDiv);
                });
                listView.dataset.loaded = 'true';
            }).catch(function() {
                listView.innerHTML = '';
                var errorDiv = document.createElement('div');
                errorDiv.className = 'list-view-loading';
                errorDiv.textContent = 'Failed to load camera data.';
                listView.appendChild(errorDiv);
            });
        }

        // ===== Aliases Tab =====
        var allAliases = [];

        async function loadAliases() {
            try {
                var resp = await fetch('/api/camera-map/aliases');
                var data = await resp.json();
                if (data.success) {
                    allAliases = data.aliases || [];
                    document.getElementById('stat-aliases').textContent = allAliases.length;
                    renderAliasTable();
                    populateAliasPrimaryDatalist();
                }
            } catch (e) {
                console.error('Error loading aliases:', e);
                var tbody = document.getElementById('alias-table-body');
                tbody.innerHTML = '';
                var tr = document.createElement('tr');
                var td = document.createElement('td');
                td.colSpan = 5;
                td.className = 'empty-state';
                td.textContent = 'Error loading aliases.';
                tr.appendChild(td);
                tbody.appendChild(tr);
            }
        }

        function renderAliasTable() {
            var tbody = document.getElementById('alias-table-body');
            var filterInput = document.getElementById('alias-search');
            var filterVal = filterInput ? filterInput.value.toLowerCase() : '';
            var countLabel = document.getElementById('alias-count-label');
            var actionsHeader = document.getElementById('alias-actions-header');

            if (actionsHeader) {
                actionsHeader.style.display = CAN_WRITE ? '' : 'none';
            }

            var filtered = allAliases.filter(function(a) {
                if (!filterVal) return true;
                return (a.primary_camera_id && a.primary_camera_id.toLowerCase().includes(filterVal)) ||
                       (a.alias_id && a.alias_id.toLowerCase().includes(filterVal)) ||
                       (a.alias_type && a.alias_type.toLowerCase().includes(filterVal));
            });

            var total = allAliases.length;
            countLabel.textContent = filtered.length + ' of ' + total + ' alias' + (total !== 1 ? 'es' : '');

            tbody.innerHTML = '';

            if (filtered.length === 0) {
                var tr = document.createElement('tr');
                var td = document.createElement('td');
                td.colSpan = 5;
                td.className = 'empty-state';
                td.textContent = total === 0 ? 'No aliases defined yet.' : 'No aliases match the filter.';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            filtered.forEach(function(alias) {
                var tr = document.createElement('tr');

                var tdPrimary = document.createElement('td');
                tdPrimary.className = 'alias-primary-cell';
                tdPrimary.textContent = alias.primary_camera_id || '';
                tr.appendChild(tdPrimary);

                var tdAlias = document.createElement('td');
                tdAlias.className = 'alias-id-cell';
                tdAlias.textContent = alias.alias_id || '';
                tr.appendChild(tdAlias);

                var tdType = document.createElement('td');
                var typeBadge = document.createElement('span');
                typeBadge.className = 'alias-type-badge';
                typeBadge.textContent = alias.alias_type || 'other';
                tdType.appendChild(typeBadge);
                tr.appendChild(tdType);

                var tdDate = document.createElement('td');
                tdDate.className = 'alias-date-cell';
                if (alias.created_date) {
                    var d = new Date(alias.created_date);
                    tdDate.textContent = d.toLocaleDateString();
                } else {
                    tdDate.textContent = '\u2014';
                }
                tr.appendChild(tdDate);

                var tdActions = document.createElement('td');
                if (CAN_WRITE) {
                    var delBtn = document.createElement('button');
                    delBtn.className = 'alias-delete-btn';
                    delBtn.textContent = 'Delete';
                    (function(id, label) {
                        delBtn.addEventListener('click', function() { deleteAlias(id, label); });
                    })(alias.id, alias.alias_id);
                    tdActions.appendChild(delBtn);
                } else {
                    tdActions.style.display = 'none';
                }
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });
        }

        function populateAliasPrimaryDatalist() {
            var datalist = document.getElementById('alias-primary-datalist');
            datalist.innerHTML = '';
            var ids = {};
            allAliases.forEach(function(a) { if (a.primary_camera_id) ids[a.primary_camera_id] = true; });
            discoveredCameras.forEach(function(c) { if (c.camera_id) ids[c.camera_id] = true; });
            Object.keys(ids).forEach(function(id) {
                var opt = document.createElement('option');
                opt.value = id;
                datalist.appendChild(opt);
            });
        }

        async function addAlias() {
            if (!CAN_WRITE) return;
            var primaryId = document.getElementById('alias-primary-id').value.trim();
            var aliasId = document.getElementById('alias-alias-id').value.trim();
            var aliasType = document.getElementById('alias-type').value;

            if (!primaryId || !aliasId) {
                showAliasStatus('Primary Camera ID and Alias ID are required.', 'error');
                return;
            }
            if (primaryId === aliasId) {
                showAliasStatus('Alias ID cannot be the same as Primary Camera ID.', 'error');
                return;
            }

            var btn = document.getElementById('btn-add-alias');
            btn.disabled = true;
            btn.textContent = 'Adding...';

            try {
                var resp = await fetch('/api/camera-map/aliases', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({primary_camera_id: primaryId, alias_id: aliasId, alias_type: aliasType})
                });
                var data = await resp.json();
                if (data.success) {
                    document.getElementById('alias-primary-id').value = '';
                    document.getElementById('alias-alias-id').value = '';
                    showAliasStatus('Alias added successfully.', 'success');
                    await loadAliases();
                } else {
                    showAliasStatus('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                console.error('Error adding alias:', e);
                showAliasStatus('Network error. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add Alias';
            }
        }

        async function deleteAlias(aliasRowId, aliasIdLabel) {
            if (!CAN_WRITE) return;
            if (!confirm('Delete alias "' + aliasIdLabel + '"?')) return;
            try {
                var resp = await fetch('/api/camera-map/aliases/' + aliasRowId, {method: 'DELETE'});
                var data = await resp.json();
                if (data.success) {
                    await loadAliases();
                } else {
                    alert('Error deleting alias: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error deleting alias:', e);
                alert('Network error deleting alias.');
            }
        }

        function showAliasStatus(msg, type) {
            var el = document.getElementById('alias-status-msg');
            el.textContent = msg;
            el.className = 'alias-status-msg ' + type;
            el.style.display = 'block';
            setTimeout(function() { el.style.display = 'none'; }, 4000);
        }

        function initAliasTab() {
            var notice = document.getElementById('alias-rbac-notice');
            var formFields = document.getElementById('alias-add-form-fields');
            if (!CAN_WRITE) {
                notice.style.display = 'block';
                formFields.style.display = 'none';
            } else {
                notice.style.display = 'none';
                formFields.style.display = 'block';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadTopology();
            initAliasTab();

            var searchInput = document.getElementById('camera-search');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) { renderCameraList(e.target.value); });
            }

            if (window.matchMedia('(max-width: 767px)').matches) {
                populateListView();
            }
        });
    </script>
</body>
</html>
